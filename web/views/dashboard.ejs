<%- include('partials/layout-start', { title: title || 'Painel', page }) %>
<section class="hero">
    <div class="hero__content">
        <h1>Centro de Controle Rep4Rep</h1>
        <p>Automatize coment√°rios, monitore contas e distribua cr√©ditos para clientes conectados √† sua rede Rep4Rep.</p>
        <div class="hero__actions">
            <button class="btn btn--primary" data-command="autoRun">‚ñ∂Ô∏è Executar autoRun</button>
            <button class="btn btn--secondary" data-command="backup">üíæ Criar backup</button>
            <a class="btn btn--ghost" href="<%= base %>/logs">üìú Ver logs</a>
        </div>
        <div class="watchdog-banner" data-watchdog-state-container>
            <span class="badge badge--muted">Modo vigia</span>
            <span class="watchdog-banner__state" data-watchdog-state data-state="off">desligado</span>
            <span class="watchdog-banner__info">√∫ltima execu√ß√£o: <strong data-watchdog-last-run>‚Äî</strong></span>
        </div>
            <p class="hero__hint">Dica: configure o arquivo <code>accounts.txt</code>, mantenha o bot do terminal rodando com a sua key e libere cr√©ditos apenas ap√≥s validar os dados do cliente.</p>
        <p class="hero__hint">Dica: configure o arquivo <code>accounts.txt</code> e garanta que o <code>REP4REP_KEY</code> est√° definido antes de rodar as automa√ß√µes.</p>
    </div>
    <aside class="hero__card">
        <h2>Resumo r√°pido</h2>
        <dl class="stat-preview">
            <div>
                <dt>Perfis cadastrados</dt>
                <dd data-stat-total><%= initialStats ? initialStats.total : '--' %></dd>
            </div>
            <div>
                <dt>Prontos para comentar</dt>
                <dd data-stat-ready><%= initialStats ? initialStats.ready : '--' %></dd>
            </div>
            <div>
                <dt>Em cooldown</dt>
                <dd data-stat-cooling><%= initialStats ? initialStats.coolingDown : '--' %></dd>
            </div>
            <div>
                <dt>Coment√°rios (24h)</dt>
                <dd data-stat-comments><%= initialStats ? initialStats.commentsLast24h : '--' %></dd>
            </div>
        </dl>
        <button class="btn btn--outline" data-command="stats">üîÑ Atualizar estat√≠sticas</button>
    </aside>
</section>

<section class="grid">
    <article class="card">
        <header class="card__header">
            <div>
                <h2>Execu√ß√£o r√°pida</h2>
                <p>Comandos seguros executados direto no servidor.</p>
            </div>
        </header>
        <div class="card__body card__body--spaced">
            <p>Os comandos s√£o executados de forma s√≠ncrona. Aguarde o retorno na √°rea de sa√≠da ao lado.</p>
            <div class="quick-actions">
                <button class="btn" data-command="autoRun">Rodar autoRun</button>
                <button class="btn" data-command="stats">Gerar estat√≠sticas</button>
                <button class="btn" data-command="backup">Criar backup</button>
            </div>
        </div>
    </article>
    <article class="card">
        <header class="card__header">
            <div>
                <h2>Sa√≠da dos comandos</h2>
                <p>Acompanhe os resultados sem sair do painel.</p>
            </div>
        </header>
        <div class="card__body">
            <pre class="command-output" data-command-output>Selecione um comando para ver o resultado aqui.</pre>
        </div>
    </article>
    <article class="card">
        <header class="card__header">
            <div>
                <h2>Modo VPS / Vigia autom√°tico</h2>
                <p>Mantenha o bot ativo em segundo plano verificando prioridades a cada ciclo.</p>
            </div>
        </header>
        <div class="card__body card__body--spaced watchdog-card">
            <dl class="watchdog-stats">
                <div>
                    <dt>Status</dt>
                    <dd data-watchdog-state data-state="off">desligado</dd>
                </div>
                <div>
                    <dt>Intervalo</dt>
                    <dd data-watchdog-interval>--</dd>
                </div>
                <div>
                    <dt>√öltima execu√ß√£o</dt>
                    <dd data-watchdog-last-run>‚Äî</dd>
                </div>
            </dl>
            <p class="watchdog-error" data-watchdog-error></p>
            <div class="watchdog-actions">
                <button class="btn btn--primary" data-command="watchdogStart">Iniciar vigia</button>
                <button class="btn btn--outline" data-command="watchdogStop">Parar</button>
                <button class="btn btn--ghost" data-watchdog-refresh>Atualizar status</button>
            </div>
            <p class="watchdog-note">O vigia executa o <strong>autoRun priorit√°rio</strong> em ciclos e respeita os limites (100 contas / 1000 coment√°rios). Configure o intervalo via <code>KEEPALIVE_INTERVAL_MINUTES</code> no seu <code>.env</code>.</p>
        </div>
    </article>
    <article class="card queue-card">
        <header class="card__header">
            <div>
                <h2>Fila de execu√ß√µes</h2>
                <p>Acompanhe os pedidos dos clientes e a previs√£o m√©dia para in√≠cio.</p>
            </div>
            <button class="btn btn--ghost" type="button" data-queue-refresh>Atualizar fila</button>
        </header>
        <div class="card__body card__body--spaced">
            <div class="queue-metrics">
                <div>
                    <span class="queue-metrics__value" data-queue-length><%= initialQueue ? initialQueue.queueLength : 0 %></span>
                    <span class="queue-metrics__label">Pedidos na fila</span>
                </div>
                <div>
                    <span class="queue-metrics__value" data-queue-average><%= initialQueue && initialQueue.averageDurationMs ? Math.round(initialQueue.averageDurationMs / 60000) + ' min' : '--' %></span>
                    <span class="queue-metrics__label">Dura√ß√£o m√©dia</span>
                </div>
            </div>
            <div class="queue-table-wrapper">
                <table class="queue-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Cliente</th>
                            <th>Status</th>
                            <th>Enfileirado em</th>
                            <th>Limites</th>
                            <th>Coment√°rios</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody data-queue-body>
                        <% if (initialQueue && initialQueue.jobs && initialQueue.jobs.length) { %>
                            <% initialQueue.jobs.forEach(function(job, index) { %>
                                <tr>
                                    <td><%= (job.position || index + 1) %></td>
                                    <td>
                                        <strong><%= job.user && (job.user.fullName || job.user.username || job.user.id) %></strong>
                                        <span class="queue-table__meta"><%= job.user && job.user.username ? '@' + job.user.username : job.user && job.user.id %></span>
                                    </td>
                                    <td>
                                        <span class="badge badge--status badge--<%= job.status === 'running' ? 'active' : 'pending' %>"><%= job.status %></span>
                                    </td>
                                    <td><%= job.enqueuedAt ? new Date(job.enqueuedAt).toLocaleString('pt-PT') : '‚Äî' %></td>
                                    <td><%= job.maxCommentsPerAccount %> c/conta ¬∑ <%= job.accountLimit %> contas</td>
                                    <td><%= job.totalComments || 0 %></td>
                                    <td>
                                        <% if (job.status === 'pending') { %>
                                            <button class="btn btn--ghost btn--pill" data-queue-cancel="<%= job.id %>">Cancelar</button>
                                        <% } else { %>
                                            <span class="badge badge--muted">Em execu√ß√£o</span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr data-queue-empty-row>
                                <td colspan="7" class="is-center is-muted">Nenhum pedido aguardando processamento.</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
            <details class="queue-history" data-queue-history-container <%= initialQueue && initialQueue.history && initialQueue.history.length ? '' : 'hidden' %>>
                <summary>Hist√≥rico recente</summary>
                <ul class="queue-history__list" data-queue-history>
                    <% if (initialQueue && initialQueue.history && initialQueue.history.length) { %>
                        <% initialQueue.history.forEach(function(item) { %>
                            <li>
                                <strong><%= item.user && (item.user.fullName || item.user.username || item.user.id) %></strong>
                                <span>‚Äî <%= item.status %> em <%= item.finishedAt ? new Date(item.finishedAt).toLocaleString('pt-PT') : '‚Äî' %></span>
                            </li>
                        <% }) %>
                    <% } %>
                </ul>
            </details>
        </div>
    </article>
</section>

<section class="card card--full">
    <header class="card__header">
        <div>
            <h2>Clientes e cr√©ditos (pr√©via)</h2>
            <p>Gerencie usu√°rios que futuramente ter√£o acesso ao painel online e ter√£o cr√©ditos debitados a cada tarefa conclu√≠da.</p>
        </div>
    </header>
    <div class="card__body card__body--split">
        <form class="user-form" data-user-form>
            <h3>Novo cliente</h3>
            <label>
                <span>Nome completo</span>
                <input type="text" name="fullName" placeholder="Ex.: Jo√£o Silva" required />
            </label>
            <label>
                <span>Username</span>
                <input type="text" name="username" placeholder="apelido para login" required />
            </label>
            <label>
                <span>Email</span>
                <input type="email" name="email" placeholder="cliente@exemplo.com" required />
            </label>
            <label>
                <span>Senha provis√≥ria</span>
                <input type="password" name="password" placeholder="Envie ao cliente e pe√ßa para trocar" minlength="8" required />
            </label>
            <label>
                <span>Data de nascimento</span>
                <input type="date" name="dateOfBirth" required />
            </label>
            <label>
                <span>Discord ID</span>
                <input type="text" name="discordId" placeholder="usuario#0000 ou ID num√©rico" required />
            </label>
            <label>
                <span>Rep4Rep ID</span>
                <input type="text" name="rep4repId" placeholder="ID √∫nico do Rep4Rep" required />
            </label>
            <label>
                <span>Telefone / WhatsApp</span>
                <input type="tel" name="phoneNumber" placeholder="+351900000000" required />
            </label>
            <label>
                <span>Chave Rep4Rep (opcional)</span>
                <input type="text" name="rep4repKey" placeholder="Cole aqui a chave fornecida ao cliente" />
            </label>
            <label>
                <span>Cr√©ditos iniciais</span>
                <input type="number" name="credits" min="0" value="10" />
            </label>
            <button type="submit" class="btn btn--primary">Cadastrar cliente</button>
        </form>
        <div class="user-list">
            <div class="user-list__header">
                <h3>Carteira atual</h3>
                <p>Cadastre clientes, valide identidades e ajuste cr√©ditos conforme as compras forem confirmadas.</p>
            </div>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th class="is-center">Cr√©ditos</th>
                        <th class="is-right">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody data-users-body>
                    <% if (initialUsers && initialUsers.length) { %>
                        <% initialUsers.forEach(function(user) { %>
                            <tr data-user-id="<%= user.id %>">
                                <td>
                                    <div class="user-identification">
                                        <strong><%= user.fullName || user.displayName || user.username %></strong>
                                        <span><%= user.email %></span>
                                    </div>
                                    <div class="user-meta">
                                        <span class="badge badge--status badge--<%= ['active','blocked','pending'].includes(user.status) ? user.status : 'muted' %>"><%= user.status %></span>
                                        <% if (user.username) { %>
                                            <span class="badge badge--muted">@<%= user.username %></span>
                                        <% } %>
                                        <% if (user.discordId) { %>
                                            <span class="badge badge--muted">Discord: <%= user.discordId %></span>
                                        <% } %>
                                        <% if (user.rep4repId) { %>
                                            <span class="badge badge--muted">Rep4Rep: <%= user.rep4repId %></span>
                                        <% } %>
                                        <% if (user.phoneNumber) { %>
                                            <span class="badge badge--muted"><%= user.phoneNumber %></span>
                                        <% } %>

                                        <% if (user.rep4repKey) { %>
                                            <span class="badge">Key definida</span>
                                        <% } else { %>
                                            <span class="badge badge--muted">Key pendente</span>
                                        <% } %>
                                    </div>
                                </td>
                                <td class="is-center">
                                    <span class="credit-count" data-user-credits><%= user.credits %></span>
                                </td>
                                <td class="is-right">
                                    <div class="credit-actions">
                                        <button type="button" class="btn btn--pill" data-credit-delta="-1">-1</button>
                                        <button type="button" class="btn btn--pill" data-credit-delta="1">+1</button>
                                        <button type="button" class="btn btn--pill" data-credit-delta="10">+10</button>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="3" class="is-center is-muted">Nenhum cliente cadastrado ainda.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</section>

<div class="toast" data-toast hidden></div>

<div class="user-editor" data-user-editor>
    <div class="user-editor__container">
        <header class="user-editor__header">
            <h3 data-user-editor-title>Gerenciar cliente</h3>
            <button type="button" class="btn btn--pill" data-user-editor-close>‚úï</button>
        </header>
        <form class="user-editor__form" data-user-editor-form>
            <div class="user-editor__grid">
                <label>
                    <span>Nome completo</span>
                    <input type="text" name="fullName" required />
                </label>
                <label>
                    <span>Username</span>
                    <input type="text" name="username" required />
                </label>
                <label>
                    <span>Email</span>
                    <input type="email" name="email" required />
                </label>
                <label>
                    <span>Telefone / WhatsApp</span>
                    <input type="tel" name="phoneNumber" required />
                </label>
                <label>
                    <span>Discord ID</span>
                    <input type="text" name="discordId" required />
                </label>
                <label>
                    <span>Rep4Rep ID</span>
                    <input type="text" name="rep4repId" required />
                </label>
                <label class="user-editor__field--wide">
                    <span>Chave Rep4Rep</span>
                    <input type="text" name="rep4repKey" placeholder="Cole aqui a chave do cliente" />
                </label>
                <label>
                    <span>Data de nascimento</span>
                    <input type="date" name="dateOfBirth" required />
                </label>
                <label>
                    <span>Cr√©ditos</span>
                    <input type="number" name="credits" min="0" step="1" />
                </label>
                <label>
                    <span>Status</span>
                    <select name="status" required>
                        <option value="active">ativo</option>
                        <option value="pending">pendente</option>
                        <option value="blocked">bloqueado</option>
                    </select>
                </label>
                <label>
                    <span>N√≠vel de acesso</span>
                    <select name="role" required>
                        <option value="customer">cliente</option>
                        <option value="admin">admin</option>
                    </select>
                </label>
                <label>
                    <span>Nova senha (opcional)</span>
                    <input type="password" name="password" placeholder="Deixe vazio para manter" />
                </label>
            </div>
            <footer class="user-editor__footer">
                <button type="submit" class="btn btn--primary">Guardar altera√ß√µes</button>
                <button type="button" class="btn btn--ghost" data-user-editor-close>Cancelar</button>
            </footer>
        </form>
    </div>
</div>

<%- include('partials/layout-end', { includePanelScript: true, initialQueue: initialQueue }) %>
<%- include('partials/layout-end', { includePanelScript: true }) %>
